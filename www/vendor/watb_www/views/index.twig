<!DOCTYPE html>
<head>
<title>foo</title>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
<script src='//api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.js'></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<link href='//api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.css' rel='stylesheet' />
<!--[if lte IE 8]>
<link href='//api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.ie.css' rel='stylesheet' >
<![endif]-->
<style>
html, body, #map {
height:100%;
width:100%;
padding:0px;
margin:0px;
} 
</style>
</head>
<body>
<div id="map"></div>
</body>
<script>
var map = L.mapbox.map('map', 'examples.map-uci7ul8p')
.setView([51.505, -0.09], 13);

function refresh_docking_stations() {
  $.ajax({
    'url': '/stations',
    'success': function(data) {
      draw_docking_stations(data);
    } 
  });
}

function format_information_popup(station) {
  return 'Bikes: ' + station.bikes + '<br/>' + 'Docks: ' + station.docks + '<br/>Last updated: ' + station.update_time + '<br/><a href="https://maps.google.com/?cbll=' + station.location + '&cbp=12,20.09,,0,5&layer=c" target="_streetview">Street view</a>'
}

function draw_docking_stations(docking_stations) {


  $(docking_stations.response.docs).each(function(idx,station) {

      if(station.{{criteria}} < 5) {
        size = 'small';
        color = '#fff';
      }
      else {
        size = 'medium';
        color = '#03f';
      }

      marker = L.mapbox.markerLayer({
        // this feature is in the GeoJSON format: see geojson.org
        // for the full specification
        type: 'Feature',
        geometry: {
        type: 'Point',
        // coordinates here are in longitude, latitude order because
        // x, y is the standard for GeoJSON and many formats
        coordinates: station.location.split(',').reverse()
        },
        properties: {
        title: station.station_name,
        description: format_information_popup(station),
        // one can customize markers by adding simplestyle properties
        // http://mapbox.com/developers/simplestyle/
        'marker-size': size,
        'marker-color': color,
        'marker-symbol': 'bicycle'
        }
        });

      
      marker.addTo(map);
});
}

refresh_docking_stations();

map.on('viewreset', function(e) {
  refresh_docking_stations();
});


</script>
</html>
