<html>
<style>
html {
  background: #EEEEEE;
}

body {
  width: 960px;
  margin: auto;
  font-family: Georgia,"Bitstream Charter",serif;
  font-size: 16px; 
  background: white; 
  padding-left: 20px;
  padding-right: 20px;  
  padding-top: 20px;
  padding-bottom: 20px;    
  border-bottom: 4px solid black;
  border-top: 4px solid black;  
  margin-top: 20px;
  margin-bottom: 20px;
}

h1 { 
  font-family: "Helvetica Neue",Arial,Helvetica,"Nimbus Sans L",sans-serif;
  color: black;
  font-size: 30px;
  margin-bottom: 0px;
}

h2 {
  color: #888888;
  font-family: "Helvetica Neue",Arial,Helvetica,"Nimbus Sans L",sans-serif;
  font-size: 16px;  
  margin-top: 0px;
}

h3 {
  background: #000000;
  color: #FFFFFF  ;
  font-family: "Helvetica Neue",Arial,Helvetica,"Nimbus Sans L",sans-serif;
  font-size: 20px;  
  margin-top: 36px;
  margin-bottom: 0px;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 10px;
}

p {
  margin-top: 4px;
}

a {
  color: #0066CC;
  text-decoration: none;
}

h3 a {
  color: #ffffff;
}

</style>
<head>
  <title>Where Are The Bikes?</title>
  <script src="js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>  
  <script>
  function list_all() {
    url = '/watb.php/scheme';
    jQuery.getJSON('/watb.php/scheme', function(json) {
      $('#results').html('<pre>API call: ' + url + '</pre>');
      jQuery.each(json, function(id, scheme) {
        $('#results').append('<p>' + id + ' (' + scheme + ')</p>' );
      });
    });
  }

  function list_denver() {
    url = '/watb.php/scheme/denver-bcycle/stations';
    jQuery.getJSON('/watb.php/scheme/denver-bcycle/stations', function(json) {
      $('#results').html('<pre>API call: ' + url + '</pre>');
      jQuery.each(json, function(idx, station) {
        $('#results').append('<p><strong>' + (idx+1) + " " + station.name + '</strong><br/>Available Bikes: ' + station.bikes + '<br/>Free Stands: ' + station.stands + '<br/><small>Updated:' + station.extra.updated + '</small></p>');
      });
    });
  }

  function list_seville_free() {
    url = '/watb.php/scheme/seville-sevici/stations?filter=2';
    jQuery.getJSON(url, function(json) {
      $('#results').html('<pre>API call: ' + url + '</pre>');
      jQuery.each(json, function(idx, station) {
        $('#results').append('<p><strong>' + (idx+1) + " " + station.name + '</strong><br/>Available Bikes: ' + station.bikes + '<br/>Free Stands: ' + station.stands + '<br/><small>Updated:' + station.extra.updated + '</small></p>');
      });
    });
  }
  
  function show_nearest_from_address() {
    
    geocoder = new google.maps.Geocoder();
    address = $('#address').val();
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        show_nearest_docking_stations(results[0].geometry.location.lng(),results[0].geometry.location.lat());
      }
      else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
        
  }
  
  function show_nearest_from_current(position) {
    show_nearest_docking_stations(position.coords.longitude, position.coords.latitude);
  }
  
  function show_nearest_docking_stations(longitude, latitude) {
      url = '/watb.php/scheme/all/stations?nearest=' + longitude + ',' + latitude + '&count=5&filter=' + $("input[@name='filter']:checked").val();
      jQuery.getJSON(url, function(json) {
        $('#results').html('<pre>API call: ' + url + '</pre>');
        $('#results').append('<p style="float: left" id="stations"></p>');
        mapurl = "http://maps.google.com/maps/api/staticmap?size=512x512&maptype=roadmap&sensor=false&";
        first = true;
        jQuery.each(json, function(idx, station) {
          if(first && station.extra.distance < 1000) {
            //display the current location in red if we're nearer than 1k from the nearest - saves zooming out too far
            mapurl += "markers=color:red|label:X|"+latitude+","+longitude+"&";
          }
          first = false;
          $('#stations').append('<p><strong>' + (idx+1) + " " + station.name + '</strong><br/>Available Bikes: ' + station.bikes + '<br/>Free Stands: ' + station.stands + '<br/><small>Distance:' + parseInt(station.extra.distance) + ' metres<br/>Updated:' + station.extra.updated + '</small></p>');
          mapurl += "markers=color:blue|label:"+(idx+1)+"|"+station.latitude+","+station.longitude+"&";
        });
        $('#results').append('<img id="map"></div>');
        $('#map').attr('src', mapurl);
      });
  }
  
  function show_nearest_from_geolocation() {
    navigator.geolocation.getCurrentPosition(show_nearest_from_current);
  }
  </script>
  
</head>
<body>
<h1>Where Are The Bikes?</h1>
<h2>An API for global cycle hire docking stations</h2>
<p>
  Where Are The Bikes (WATB) is a framework that enables you to do stuff with data from docking stations in bicycle hire schemes. Specifically it...
  <ul>
    <li>provides an easily extendable mechanism for retrieving docking station information from any cycle hire scheme</li> 
    <li>exposes a single, consistent API for retrieving the state of docking stations across the world</li>
  </ul>
If you write any sort of application that needs access to information about docking stations WATB is for you. It's intended for you to install on your own server - you can get the code at <a href="http://github.com/andrewl/watb" target="_other">http://github.com/andrewl/watb</a>. There's an install hosted at <a href="http://watb.andrewl.net" target="_other">http://watb.andrewl.net</a> which you can play around with <a href="#demo">below</a>.
</p>
<p>Jump to: <a href="#examples">Example Applications</a> : <a href="#demo">Demos</a> : <a href="#architecture">Architecture</a> : <a href="#new">Adding New Hire Schemes</a> : <a href="#api">API</a></p>
<a name="examples"></a>
<h3>Example Applications</h3>
<p>
  <strong>Waterloo Bikes twitter feed</strong> <a href="http://twitter.com/waterloo_bikes" target="_other">http://twitter.com/waterloo_bikes</a><br/>
  Docking stations join the Internet of Things! waterloo_bikes tweets when any of the docking stations around London Waterloo Station has no bikes or no free stations, then tweets again when bikes or stands are available again.
</p>
<p>
  <strong>Where Are The Bikes Global Coverage Map</strong> <a href="/globalmap.html" target="_other">/globalmap.html</a><br/>
  A dynamic, queryable map showing all of the docking stations in this installation of Where Are The Bikes.
</p>

<p>
  <strong>TwitABike twitter bot</strong> <a href="http://twitter.com/twitabike" target="_other">http://twitter.com/twitabike</a><br/>
  Send a geocoded tweet to @twitabike and the bot will tweet you back your nearest docking station with bikes, along with a map showing their locations. Tweet 'space' and it'll show you docking stations with spaces
</p>
<a name="demo"></a>
<h3>Demos</h3>
<p>A very simple frontend to a few of the functions exposed by the <a href="http://github.com/andrewl/watb">Where Are The Bikes API</a><br/><strong>NB</strong> This is just for demonstration purposes. The bike station data on this hosted version is only updated on an hourly basis. Get the source at <a href="http://github.com/andrewl/watb">http://github.com/andrewl/watb</a> to run it on your own server.</p>
<ul>
  <li><strong>List all schemes:</strong> <button onclick="list_all()">Go!</button></li>
  <li><strong>List all stations in the Denver Bcycle scheme:</strong> <button onclick="list_denver()">Go!</button></li>
  <li><strong>List all stations with free stands in the Seville Sevici scheme:</strong> <button onclick="list_seville_free()">Go!</button></li>
  <li><strong>Proximity Search:</strong> Enter an address to display nearby docking stations.</li>
</ul>
<small>Should be good for locations in Dublin, London, Paris, Brussels, Montreal, Denver, Seville, Rio de Janeiro, Toyama, Melbourne, Auckland and many cities and towns in Germany and Austria.</small><br/>
<input type="text" size="80" id="address"></input><br/>
<button onclick="show_nearest_from_address();">Search near this address</button>
OR
<button onclick="show_nearest_from_geolocation();">Attempt to search near your current location (can be flaky)</button><br/>
<input onclick="show_nearest_from_address();" checked type="radio" id="filter" name="filter" value="0" />All Stations<br />
<input onclick="show_nearest_from_address();" type="radio" id="filter" name="filter" value="1" />Only Stations With Bikes<br 
<input onclick="show_nearest_from_address();" type="radio" id="filter" name="filter" value="2" />Only Stations With Free Stands<br />
<div>
<div id="results">
</div>
</div>
</p>


<a name="architecture"></a>
<h3>Architecture</h3>
<p>Very simple - a backend 'feeder' script that sucks data from hire schemes into a database, and a frontend API script for handling requests, querying the database and returning results. More details to come...</p>

<a name="new"></a>
<h3>Adding New Hire Schemes</h3>
<p>
To get data from a new scheme into the database all you need to do is create a new file <MYSCHEME>.class.php in the schemes directory. This should contain a class extending BikeHireFeeder and implementing the update(), name() and description() methods. The update() method should just do whatever it needs to do to get the data for the scheme, create a new Station object for each docking station and call the Station::save() method. See london.class.php for an example/template.
</p>

<a name="api"></a>
<h3>API</h3>
<p>
  /scheme - returns an array of all schemes keyed by their id<br/>
  /scheme/id - returns information about scheme id<br/>
  /scheme/id/stations - returns information about all stations in scheme id. Set scheme id to 'all' for all schemes. Takes the following query options to limit the number of stations:
  <ul>
  <li>filter = 4 (only stations with no free stands) 3 (only stations with no bikes) 2 (only stations with empty stands) or 1 (only stations with bikes available)</li>
  <li>bbox = x0,y0,x1,y1 (only stations within these bounds)</li>
  <li>nearest = x0,y0 (order by distance from x0, y0)</li>
  <li>max_dist = max distance in metres from nearest</li>
  <li>count = number of stations to return</li>
  <li>page = used in conjunction with count. Returns n'th page of count results</li>
  </ul>
  eg /scheme/all/stations?filter=2&nearest=0.1,51.2&max_dist=1000&count=5 will return a maximum of 5 nearest stations with empty stands within 1000 metres to 0.1 longitude, 51.2 latitude.<br/>
  /scheme/id/stations/sid - return information about station sid in scheme id.
</p>
<h3>About</h3>
<p>Where Are The Bikes is a project by <a target="_other" href="http://andrewl.net">Andrew Larcombe</a> -  <a target="_other" href="http://andrewl.net">http://andrewl.net</a></p>
<p>All the code can be obtained from <a target="_other" href="http://github.com/andrewl/watb">http://github.com/andrewl/watb</a> - bug reports welcome, patches even more so!</p>
</body>
</html>