<html>
<head>
  <title>Where Are The Bikes?</title>
  <script src="js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>  
  <script>
  function show_nearest_from_address() {
    
    geocoder = new google.maps.Geocoder();
    address = $('#address').val();
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        show_nearest_docking_stations(results[0].geometry.location.lng(),results[0].geometry.location.lat());
      }
      else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
        
  }
  
  function show_nearest_from_current(position) {
    show_nearest_docking_stations(position.coords.longitude, position.coords.latitude);
  }
  
  function show_nearest_docking_stations(longitude, latitude) {
    
      jQuery.getJSON('/nearest.php/' + longitude + '/' +  latitude + '/5', function(json) {
        $('#json').html('<pre>' + json + '</pre>');
        mapurl = "http://maps.google.com/maps/api/staticmap?size=512x512&maptype=roadmap&sensor=false&";
        $('div#stations').html('');
        first = true;
        jQuery.each(json, function(idx, station) {
          if(first && station.extra.distance < 1000) {
            //display the current location in red if we're nearer than 1k from the nearest - saves zooming out too far
            mapurl += "markers=color:red|label:X|"+latitude+","+longitude+"&";
          }
          first = false;
          $('div#stations').append('<p><strong>' + (idx+1) + " " + station.name + '</strong><br/>Available Bikes: ' + station.bikes + '<br/>Free Stands: ' + station.stands + '<br/><small>Distance:' + parseInt(station.extra.distance) + ' metres<br/>Updated:' + station.extra.updated + '</small></p>');
          mapurl += "markers=color:blue|label:"+(idx+1)+"|"+station.latitude+","+station.longitude+"&";
        });
        $('#map').attr('src', mapurl);
      });
  }
  
  function show_nearest_from_geolocation() {
    navigator.geolocation.getCurrentPosition(show_nearest_from_current);
  }
  </script>
  
</head>
<body>
<div>
<p>A very simple frontend to the <a href="http://github.com/andrewl/watb">Where Are The Bikes API</a></p>
<p>Enter an address to display nearby docking stations:<br/>
<textarea id="address"></textarea><br/>
<button onclick="show_nearest_from_address();">Search near this address</button>
OR
<button onclick="show_nearest_from_geolocation();">Attempt to search near your current location (can be flaky)</button>
</p>
<div>

<div style="float: left;" id="stations">  
</div>

<img id="map">
</div>

</body>
</html>