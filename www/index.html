<html>
<head>
  <title>Where Are The Bikes?</title>
  <script src="js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>  
  <script>
  function list_all() {
    url = '/watb.php/scheme';
    jQuery.getJSON('/watb.php/scheme', function(json) {
      $('#results').html('<pre>API call: ' + url + '</pre>');
      jQuery.each(json, function(id, scheme) {
        $('#results').append('<p>' + id + ' (' + scheme + ')</p>' );
      });
    });
  }

  function list_denver() {
    url = '/watb.php/scheme/denver-bcycle/stations';
    jQuery.getJSON('/watb.php/scheme/denver-bcycle/stations', function(json) {
      $('#results').html('<pre>API call: ' + url + '</pre>');
      jQuery.each(json, function(idx, station) {
        $('#results').append('<p><strong>' + (idx+1) + " " + station.name + '</strong><br/>Available Bikes: ' + station.bikes + '<br/>Free Stands: ' + station.stands + '<br/><small>Updated:' + station.extra.updated + '</small></p>');
      });
    });
  }

  function list_seville_free() {
    url = '/watb.php/scheme/seville-sevici/stations?filter=2';
    jQuery.getJSON(url, function(json) {
      $('#results').html('<pre>API call: ' + url + '</pre>');
      jQuery.each(json, function(idx, station) {
        $('#results').append('<p><strong>' + (idx+1) + " " + station.name + '</strong><br/>Available Bikes: ' + station.bikes + '<br/>Free Stands: ' + station.stands + '<br/><small>Updated:' + station.extra.updated + '</small></p>');
      });
    });
  }
  
  function show_nearest_from_address() {
    
    geocoder = new google.maps.Geocoder();
    address = $('#address').val();
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        show_nearest_docking_stations(results[0].geometry.location.lng(),results[0].geometry.location.lat());
      }
      else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
        
  }
  
  function show_nearest_from_current(position) {
    show_nearest_docking_stations(position.coords.longitude, position.coords.latitude);
  }
  
  function show_nearest_docking_stations(longitude, latitude) {
      url = '/watb.php/scheme/all/stations?nearest=' + longitude + ',' + latitude + '&count=5&filter=' + $("input[@name='filter']:checked").val();
      jQuery.getJSON(url, function(json) {
        $('#results').html('<pre>API call: ' + url + '</pre>');
        $('#results').append('<p style="float: left" id="stations"></p>');
        mapurl = "http://maps.google.com/maps/api/staticmap?size=512x512&maptype=roadmap&sensor=false&";
        first = true;
        jQuery.each(json, function(idx, station) {
          if(first && station.extra.distance < 1000) {
            //display the current location in red if we're nearer than 1k from the nearest - saves zooming out too far
            mapurl += "markers=color:red|label:X|"+latitude+","+longitude+"&";
          }
          first = false;
          $('#stations').append('<p><strong>' + (idx+1) + " " + station.name + '</strong><br/>Available Bikes: ' + station.bikes + '<br/>Free Stands: ' + station.stands + '<br/><small>Distance:' + parseInt(station.extra.distance) + ' metres<br/>Updated:' + station.extra.updated + '</small></p>');
          mapurl += "markers=color:blue|label:"+(idx+1)+"|"+station.latitude+","+station.longitude+"&";
        });
        $('#results').append('<img id="map"></div>');
        $('#map').attr('src', mapurl);
      });
  }
  
  function show_nearest_from_geolocation() {
    navigator.geolocation.getCurrentPosition(show_nearest_from_current);
  }
  </script>
  
</head>
<body>
<div>
<p>A very simple frontend to a few of the functions exposed by the <a href="http://github.com/andrewl/watb">Where Are The Bikes API</a><br/><strong>NB</strong> This is just for demonstration purposes. The bike station data is only updated on an hourly basis. Get the source at <a href="http://github.com/andrewl/watb">http://github.com/andrewl/watb</a> to run it on your own server.</p>
<p><strong>a) List all schemes:</strong> <button onclick="list_all()">Go!</button><br/>
<strong>b) List all stations in the Denver Bcycle scheme:</strong> <button onclick="list_denver()">Go!</button><br/>
<strong>c) List all stations with free stands in the Seville Sevici scheme:</strong> <button onclick="list_seville_free()">Go!</button><br/>
<strong>d) Proximity Search:</strong> Enter an address to display nearby docking stations.<br/>
Should be good for locations in Dublin, London, Paris, Brussels, Montreal, Denver and Seville.<br/>
<input type="text" size="80" id="address"></input><br/>
<button onclick="show_nearest_from_address();">Search near this address</button>
OR
<button onclick="show_nearest_from_geolocation();">Attempt to search near your current location (can be flaky)</button><br/>
<input onclick="show_nearest_from_address();" checked type="radio" id="filter" name="filter" value="0" />All Stations<br />
<input onclick="show_nearest_from_address();" type="radio" id="filter" name="filter" value="1" />Only Stations With Bikes<br />
<input onclick="show_nearest_from_address();" type="radio" id="filter" name="filter" value="2" />Only Stations With Free Stands<br />
</p>

<div>
<strong>Results</strong>
<div id="results">
</div>
</div>


</body>
</html>